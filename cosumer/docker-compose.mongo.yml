services:
  mongo-primary:
    image: mongo
    container_name: mongo-primary
    command: mongod --replSet rs0 --bind_ip_all
    ports:
      - "27017:27017"
    volumes:
      - mongo-primary-data:/data/db
    networks:
      - mongo-cluster
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  mongo-secondary1:
    image: mongo
    container_name: mongo-secondary1
    command: mongod --replSet rs0 --bind_ip_all
    ports:
      - "27018:27017"
    volumes:
      - mongo-secondary1-data:/data/db
    networks:
      - mongo-cluster
    restart: unless-stopped
    depends_on:
      mongo-primary:
        condition: service_healthy

  mongo-secondary2:
    image: mongo
    container_name: mongo-secondary2
    command: mongod --replSet rs0 --bind_ip_all
    ports:
      - "27019:27017"
    volumes:
      - mongo-secondary2-data:/data/db
    networks:
      - mongo-cluster
    restart: unless-stopped
    depends_on:
      mongo-primary:
        condition: service_healthy

  mongo-init-replica:
    image: mongo
    container_name: mongo-init-replica
    networks:
      - mongo-cluster
    depends_on:
      mongo-primary:
        condition: service_healthy
      mongo-secondary1:
        condition: service_started
      mongo-secondary2:
        condition: service_started
    command: >
      mongosh --host mongo-primary:27017 --eval '
        rsConfig = {
          _id: "rs0",
          members: [
            { _id: 0, host: "mongo-primary:27017", priority: 2 },
            { _id: 1, host: "mongo-secondary1:27017", priority: 1 },
            { _id: 2, host: "mongo-secondary2:27017", priority: 1 }
          ]
        };
        rs.initiate(rsConfig);
        rs.status();
      '
    restart: "no"

volumes:
  mongo-primary-data:
  mongo-secondary1-data:
  mongo-secondary2-data:

networks:
  mongo-cluster:
    name: mongo-cluster
    driver: bridge
